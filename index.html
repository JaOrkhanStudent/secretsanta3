<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Secret Santa</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    .box {
      max-width: 400px; margin: auto; background: white; padding: 20px;
      border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    input, button { width: 100%; padding: 10px; margin-top: 10px; font-size: 16px; }
  </style>
</head>
<body>

<div class="box">
  <h2>Secret Santa</h2>
  <p>Enter your name:</p>
  <input type="text" id="name" placeholder="Your name">
  <button onclick="start()">Get Name</button>
  <p id="output"></p>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>

<script>
  const firebaseConfig = {
    databaseURL: "https://secretsanta-c77f8-default-rtdb.firebaseio.com/"
  };

  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  async function start() {
    const user = document.getElementById("name").value.trim();
    if (!user) return alert("Enter your name!");

    // Save user in list
    await db.ref('players/' + user).set(true);

    assign(user);
  }

  async function assign(user) {
    const playersSnap = await db.ref('players').get();
    const players = Object.keys(playersSnap.val());

    const assignedSnap = await db.ref('assigned').get();
    const alreadyAssigned = assignedSnap.exists() ? assignedSnap.val() : {};

    // If this user already has a saved assignment → show it
    if (alreadyAssigned[user]) {
      document.getElementById("output").innerText = "You got: " + alreadyAssigned[user];
      return;
    }

    // Filter available names
    const usedTargets = Object.values(alreadyAssigned);
    const available = players.filter(n => n !== user && !usedTargets.includes(n));

    if (available.length === 0) {
      alert("No available names left — wait for others.");
      return;
    }

    // Pick name randomly
    const result = available[Math.floor(Math.random() * available.length)];

    // ❗ Use transaction so no one else can take it in same second
    db.ref('assigned/' + user).transaction(current => {
      if (current === null) return result;
      return; // If someone assigned during the process → do nothing
    }).then(r => {
      if (r.committed) {
        document.getElementById("output").innerText = "You got: " + result;
      } else {
        alert("Someone else got that name at the same time — try again.");
      }
    });
  }
</script>
</body>
</html>
